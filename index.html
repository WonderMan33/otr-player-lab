<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Old Time Radio Archive â€” hosted by Golden Radio Hour</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='46' fill='%23d7b24a'/%3E%3Ctext x='50' y='64' font-size='52' text-anchor='middle'%3E%F0%9F%93%BB%3C/text%3E%3C/svg%3E" />
  <style>
    :root{
      --bg0:#070707;
      --bg1:#0d0d0d;
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --gold: #f5c24b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(245,194,75,.16), transparent 60%),
        radial-gradient(1000px 600px at 80% 20%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{ width:min(980px, 94vw); margin: 18px auto 30px; }
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      border-radius: 18px;
      backdrop-filter: blur(8px);
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:40px;height:40px;border-radius:14px; display:grid;place-items:center;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.22), rgba(0,0,0,.55));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 30px rgba(0,0,0,.40);
      font-size:20px;
    }
    .brand h1{ margin:0; font-size:16px; letter-spacing:.6px; font-weight:800; }
    .brand .sub{ margin-top:2px; font-size:12px; color: var(--muted); letter-spacing:.4px; }

    /* Root mode pills */
    .modePills{
      display:flex; justify-content:center; gap:14px; margin: 14px auto 10px; flex-wrap:wrap;
    }
    .pillBtn{
      padding: 12px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.18), rgba(0,0,0,.38) 55%, rgba(0,0,0,.55));
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-size: 14px;
      letter-spacing: .8px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), 0 8px 24px rgba(0,0,0,.35);
      user-select:none;
    }
    .pillBtn:hover{ border-color: rgba(245,194,75,.55); }
    .pillBtn.active{
      border-color: rgba(245,194,75,.90);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10),
                  0 0 0 3px rgba(245,194,75,.12),
                  0 10px 30px rgba(0,0,0,.40);
    }

    /* Player card */
    .card{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      border-radius: 20px;
      padding: 14px;
      backdrop-filter: blur(8px);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }

    .titleLine{ font-weight: 900; letter-spacing: .4px; font-size: 14px; margin: 2px 0 6px; }
    .metaLine{ font-size: 12px; color: var(--muted); margin: 0 0 12px; min-height: 16px; }

    .playerRow{ display:flex; align-items:flex-end; gap:12px; flex-wrap:wrap; }
    .controls{
      flex:1;
      min-width: 280px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
      background: rgba(0,0,0,.18);
    }
    .btnRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom: 10px; justify-content:center; }
    .btn{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
      font-size: 13px;
      letter-spacing: .5px;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(245,194,75,.55); }
    .btn.primary{
      border-color: rgba(245,194,75,.70);
      background: rgba(245,194,75,.12);
    }
    .timeRow{ display:flex; align-items:center; gap:10px; font-size: 12px; color: var(--muted); }
    .range{ width:100%; accent-color: var(--gold); }

    /* Vertical volume */
    .volRail{
      width: 52px;
      display:flex; align-items:center; justify-content:center;
      padding: 8px 6px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.18);
    }
    .volMain{
      height: 150px;
      width: 28px;
      writing-mode: vertical-lr;
      direction: rtl;
      accent-color: var(--gold);
    }

    /* Channel dock */
    nav.dock{ margin-top: 12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .dockBtn{
      padding: 11px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.14), rgba(0,0,0,.42) 60%, rgba(0,0,0,.55));
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-size: 13px;
      letter-spacing: .6px;
      user-select:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    .dockBtn.active{
      border-color: rgba(245,194,75,.85);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08), 0 0 0 3px rgba(245,194,75,.12);
    }

    /* Show mode panel */
    .showPanel{
      margin: 12px auto 0;
      max-width: 860px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; }
    select.select{
      width: min(520px, 100%);
      max-width: 520px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.30);
      color: var(--text);
      font-size: 14px;
    }
    .smallNote{ margin-top: 8px; text-align:center; font-size: 12px; color: var(--muted); }
    .episodeBox{
      margin-top: 10px;
      max-height: 360px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 6px;
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .epRow{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      cursor:pointer;
      display:flex;
      gap:12px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .epRow:hover{ background: rgba(255,255,255,.03); }
    .epRow.active{ background: rgba(245,194,75,.10); }
    .epTitle{ font-size: 13px; font-weight: 800; }
    .epMeta{ font-size: 12px; color: var(--muted); white-space:nowrap; }

    footer{ margin-top: 14px; text-align:center; font-size: 12px; color: var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">ðŸ“»</div>
        <div>
          <h1>Old Time Radio Archive</h1>
          <div class="sub">hosted by Golden Radio Hour</div>
        </div>
      </div>
    </header>

    <div class="modePills">
      <button class="pillBtn active" id="pillListenChannel" type="button">Listen by Channel</button>
      <button class="pillBtn" id="pillListenShow" type="button">Listen by Show</button>
    </div>

    <div class="card">
      <div class="titleLine" id="nowTitle">Loadingâ€¦</div>
      <div class="metaLine" id="nowMeta"> </div>

      <div class="playerRow">
        <div class="controls">
          <div class="btnRow">
            <button class="btn" id="btnPrev" type="button">âŸµ Prev</button>
            <button class="btn primary" id="btnPlay" type="button">Play</button>
            <button class="btn" id="btnNext" type="button">Next âŸ¶</button>
            <button class="btn" id="btnStop" type="button">Stop</button>
          </div>

          <input class="range" id="seek" type="range" min="0" max="1000" value="0" />

          <div class="timeRow">
            <div id="tCur">0:00</div>
            <div style="flex:1"></div>
            <div id="tDur">0:00</div>
          </div>
        </div>

        <div class="volRail" title="Volume">
          <input id="volMain" class="volMain" type="range" min="0" max="1" step="0.01" value="0.6" aria-label="Volume" />
        </div>
      </div>

      <nav class="dock" id="dock" aria-label="Channels"></nav>

      <div class="showPanel" id="showPanel" style="display:none;">
        <div class="row">
          <select id="showSelectInline" class="select">
            <option value="__all__">Select a showâ€¦</option>
          </select>
        </div>
        <div class="smallNote">Pick a show to start (no autoplay until you choose). Then use Prev/Next to skip episodes.</div>
        <div class="episodeBox" id="episodeBox"></div>
      </div>
    </div>

    <footer>
      Tip: Use <b>Listen by Show</b> to browse programs, or <b>Listen to Channel</b> for radio-style listening.
    </footer>
  </div>

  <audio id="audio" preload="none" crossorigin="anonymous"></audio>

  <script>
  "use strict";

  // ---------- helpers ----------
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }
  function safeShow(el, on){
    if(!el) return;
    el.style.display = on ? "" : "none";
  }
  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec || 0));
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  // ---------- DOM ----------
  const pillListenChannel = document.getElementById("pillListenChannel");
  const pillListenShow = document.getElementById("pillListenShow");
  const dock = document.getElementById("dock");
  const showPanel = document.getElementById("showPanel");
  const showSelectInline = document.getElementById("showSelectInline");
  const episodeBox = document.getElementById("episodeBox");

  const nowTitle = document.getElementById("nowTitle");
  const nowMeta  = document.getElementById("nowMeta");

  const btnPrev = document.getElementById("btnPrev");
  const btnPlay = document.getElementById("btnPlay");
  const btnNext = document.getElementById("btnNext");
  const btnStop = document.getElementById("btnStop");

  const seek = document.getElementById("seek");
  const tCur = document.getElementById("tCur");
  const tDur = document.getElementById("tDur");
  const volMain = document.getElementById("volMain");

  const audioEl = document.getElementById("audio");
  audioEl.volume = Number(volMain.value || 0.6);

  // ---------- app state ----------
  let mode = "channel"; // "channel" | "show"
  let allTracks = [];
  let showIndex = new Map(); // showKey -> {name, tracks}
  let currentShowKey = null;
  let currentQueue = [];
  let currentIdx = -1;

  // Channels are heuristic (since JSON typically has show + title + url)
  const CHANNELS = [
    { id:"detective", label:"Detective",  test: s => /detective|sleuth|noir|private|marlowe|falcon|regan|diamond|wolfe|dollar|broadway|beat/i.test(s) },
    { id:"mystery",   label:"Mystery",    test: s => /mystery|whistler|murder|case|investigation/i.test(s) },
    { id:"suspense",  label:"Suspense",   test: s => /suspense|terror|thriller/i.test(s) },
    { id:"horror",    label:"Horror",     test: s => /horror|haunt|ghost|vamp|demon|weird|night|dark/i.test(s) },
    { id:"scifi",     label:"Sci-Fi",     test: s => /x minus|x\\-minus|science|space|planet|alien|robot|twilight|zone/i.test(s) },
    { id:"western",   label:"Western",    test: s => /gunsmoke|six shooter|ranger|west|cowboy|texas/i.test(s) },
    { id:"comedy",    label:"Comedy",     test: s => /comedy|molly|mcgee|jack benny|burns|allen|lucille|abbott|costello/i.test(s) },
    { id:"theater",   label:"Radio Theater", test: s => /radio mystery theater|cbs radio|playhouse|theater|theatre/i.test(s) },
    { id:"all",       label:"All",        test: _ => true },
  ];
  let currentChannelId = "detective";

  // ---------- mode switching ----------
  function setModeFromUI(newMode){
    mode = newMode;
    pillListenChannel.classList.toggle("active", mode === "channel");
    pillListenShow.classList.toggle("active", mode === "show");
    safeShow(dock, mode === "channel");
    safeShow(showPanel, mode === "show");
    updateNowPlayingUI();
  }
  pillListenChannel.addEventListener("click", () => setModeFromUI("channel"));
  pillListenShow.addEventListener("click", () => setModeFromUI("show"));

  // ---------- indexing ----------
  function showNameOf(t){
    return (t.showTitle || t.show || "").trim();
  }
  function showKeyOf(t){
    return (t.show || showNameOf(t) || "unknown").toLowerCase().trim();
  }
  function buildShowIndex(){
    showIndex = new Map();
    for(const t of allTracks){
      const key = showKeyOf(t);
      if(!showIndex.has(key)){
        showIndex.set(key, { key, name: showNameOf(t) || t.show || "Unknown", tracks: [] });
      }
      showIndex.get(key).tracks.push(t);
    }
    for(const v of showIndex.values()){
      v.tracks.sort((a,b) => String(a.displayTitle||a.title||"").localeCompare(String(b.displayTitle||b.title||"")));
    }
  }
  function populateShowSelect(){
    const items = Array.from(showIndex.values())
      .sort((a,b) => a.name.localeCompare(b.name));
    showSelectInline.innerHTML =
      `<option value="__all__">Select a showâ€¦</option>` +
      items.map(v => `<option value="${escapeHtml(v.key)}">${escapeHtml(v.name)}</option>`).join("");
  }

  // ---------- channel queues ----------
  function buildChannelQueue(channelId){
    const ch = CHANNELS.find(x => x.id === channelId) || CHANNELS[CHANNELS.length-1];
    const arr = allTracks.filter(t => ch.test(`${showNameOf(t)} ${t.title||""}`)).slice();
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }
  function renderDock(){
    dock.innerHTML = "";
    const ordered = [...CHANNELS.filter(c=>c.id!=="all"), CHANNELS.find(c=>c.id==="all")].filter(Boolean);
    for(const ch of ordered){
      const b = document.createElement("button");
      b.type="button";
      b.className = "dockBtn" + (ch.id===currentChannelId ? " active" : "");
      b.textContent = ch.label;
      b.addEventListener("click", () => {
        currentChannelId = ch.id;
        dock.querySelectorAll(".dockBtn").forEach(x => x.classList.remove("active"));
        b.classList.add("active");

        setModeFromUI("channel");
        currentQueue = buildChannelQueue(currentChannelId);
        currentIdx = 0;
        playIndex(currentIdx, true);
      });
      dock.appendChild(b);
    }
  }

  // ---------- show mode ----------
  function renderEpisodes(){
    episodeBox.innerHTML = "";
    if(!currentShowKey){
      episodeBox.innerHTML = `<div style="padding:12px;color:rgba(255,255,255,.70)">Pick a show to see episodes.</div>`;
      return;
    }
    const group = showIndex.get(currentShowKey);
    if(!group || !group.tracks.length){
      episodeBox.innerHTML = `<div style="padding:12px;color:rgba(255,255,255,.70)">No episodes found for this show.</div>`;
      return;
    }
    group.tracks.forEach((t, idx) => {
      const row = document.createElement("div");
      row.className = "epRow" + (idx===currentIdx ? " active" : "");
      row.innerHTML = `<div class="epTitle">${escapeHtml(t.displayTitle || t.title || "Untitled")}</div>
                       <div class="epMeta">${t.durationSeconds ? escapeHtml(fmtTime(t.durationSeconds)) : ""}</div>`;
      row.addEventListener("click", () => {
        currentQueue = group.tracks;
        currentIdx = idx;
        episodeBox.querySelectorAll(".epRow").forEach((r,i)=>r.classList.toggle("active", i===currentIdx));
        playIndex(currentIdx, true);
      });
      episodeBox.appendChild(row);
    });
  }

  showSelectInline.addEventListener("change", () => {
    const v = showSelectInline.value;
    if(!v || v==="__all__"){
      currentShowKey = null;
      currentQueue = [];
      currentIdx = -1;
      renderEpisodes();
      updateNowPlayingUI();
      return;
    }
    currentShowKey = v;
    setModeFromUI("show");
    currentQueue = showIndex.get(currentShowKey)?.tracks || [];
    currentIdx = -1; // no autoplay until user selects episode or presses Play
    renderEpisodes();
    updateNowPlayingUI();
  });

  // ---------- player ----------
  let userSeeking = false;

  function setPlayButton(isPlaying){
    btnPlay.textContent = isPlaying ? "Pause" : "Play";
  }

  function updateNowPlayingUI(){
    if(mode==="channel"){
      const name = (CHANNELS.find(c=>c.id===currentChannelId)?.label) || "Channel";
      const t = currentQueue[currentIdx];
      nowTitle.textContent = t ? (t.displayTitle || t.title || `Channel: ${name}`) : "Ready.";
      nowMeta.textContent = `Channel: ${name}`;
    }else{
      const showName = currentShowKey ? (showIndex.get(currentShowKey)?.name || "Show") : "Show";
      const t = currentQueue[currentIdx];
      nowTitle.textContent = t ? (t.displayTitle || t.title || "Untitled") : `Show: ${showName}`;
      nowMeta.textContent = `Show mode: ${showName}`;
    }
  }

  function loadTrack(t){
    if(!t){
      audioEl.removeAttribute("src");
      audioEl.load();
      return;
    }
    audioEl.src = t.url;
    audioEl.load();
    updateNowPlayingUI();
  }

  async function playIndex(idx, autoplay){
    if(!currentQueue.length) return;
    idx = clamp(idx, 0, currentQueue.length-1);
    currentIdx = idx;
    loadTrack(currentQueue[currentIdx]);

    if(mode==="show"){
      episodeBox.querySelectorAll(".epRow").forEach((r,i)=>r.classList.toggle("active", i===currentIdx));
      const active = episodeBox.querySelectorAll(".epRow")[currentIdx];
      if(active) active.scrollIntoView({block:"nearest"});
    }

    if(autoplay){
      try{
        await audioEl.play();
        setPlayButton(true);
      }catch(e){
        setPlayButton(false);
      }
    }else{
      setPlayButton(false);
    }
  }

  function stopPlayback(){
    audioEl.pause();
    audioEl.currentTime = 0;
    setPlayButton(false);
  }

  btnPlay.addEventListener("click", async () => {
    if(!audioEl.src){
      if(mode==="channel"){
        currentQueue = buildChannelQueue(currentChannelId);
        currentIdx = 0;
        await playIndex(currentIdx, true);
        return;
      }
      if(mode==="show" && currentShowKey){
        currentQueue = showIndex.get(currentShowKey)?.tracks || [];
        if(!currentQueue.length) return;
        if(currentIdx < 0) currentIdx = 0;
        await playIndex(currentIdx, true);
      }
      return;
    }
    if(audioEl.paused){
      try{ await audioEl.play(); setPlayButton(true); }catch(e){ setPlayButton(false); }
    }else{
      audioEl.pause();
      setPlayButton(false);
    }
  });

  btnPrev.addEventListener("click", () => {
    if(!currentQueue.length) return;
    playIndex(Math.max(0, currentIdx-1), true);
  });
  btnNext.addEventListener("click", () => {
    if(!currentQueue.length) return;
    playIndex(Math.min(currentQueue.length-1, currentIdx+1), true);
  });
  btnStop.addEventListener("click", stopPlayback);

  volMain.addEventListener("input", () => {
    audioEl.volume = Number(volMain.value);
  });

  audioEl.addEventListener("ended", () => {
    if(!currentQueue.length) return;
    if(currentIdx < currentQueue.length-1) playIndex(currentIdx+1, true);
    else setPlayButton(false);
  });

  audioEl.addEventListener("timeupdate", () => {
    if(userSeeking) return;
    const dur = audioEl.duration || 0;
    const cur = audioEl.currentTime || 0;

    tCur.textContent = fmtTime(cur);
    tDur.textContent = fmtTime(dur);

    if(dur > 0){
      seek.value = String(Math.floor((cur/dur)*1000));
    }else{
      seek.value = "0";
    }
  });

  seek.addEventListener("input", () => { userSeeking = true; });
  seek.addEventListener("change", () => {
    const dur = audioEl.duration || 0;
    if(dur > 0){
      const pct = Number(seek.value)/1000;
      audioEl.currentTime = dur * pct;
    }
    userSeeking = false;
  });

  // ---------- load JSON ----------
  async function loadShowsJson(){
    const url = "./shows.json";
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("Failed to load shows.json: " + res.status);
    const json = await res.json();
    if(!Array.isArray(json)) throw new Error("shows.json is not an array");
    return json;
  }

  async function init(){
    setModeFromUI("channel");

    allTracks = await loadShowsJson();

    buildShowIndex();
    populateShowSelect();
    renderDock();

    // Prime channel queue (no autoplay)
    currentQueue = buildChannelQueue(currentChannelId);
    currentIdx = -1;

    nowTitle.textContent = "Ready.";
    nowMeta.textContent = "Pick a channel, or switch to Show mode to browse programs.";
    tCur.textContent = "0:00";
    tDur.textContent = "0:00";
  }

  init().catch(err => {
    console.error(err);
    nowTitle.textContent = "Couldnâ€™t load shows.json";
    nowMeta.textContent = String(err?.message || err);
  });
  </script>
</body>
</html>
